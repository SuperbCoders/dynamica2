# Dynamica
## Локальный деплой
- создать в config: application.yml / database.yml / secrets.yml
- 
``` 
bundle exec rake db:schema:load
bundle exec rake db:seed
```
## API

Входные данные передаются в виде JSON. Результат возвращается также в виде JSON.

### Endpoint

http://dev-dynamica.onomnenado.ru

### Заголовки

Для работы с API необходимо передавать следующие заголовки:

**Content-Type**

    Content-Type: application/json

**Authorization**

Надо передать его API-токен пользователя в заголовке следующим образом:

    Authorization: Token token="32_letters_and_digits_token"

### Шаг 1. Загрузка данных

#### POST /api/v1/projects/:project_id/values

Загружает значения в проект с указанным в URL `project_id`.

##### Входные данные

###### item

Продукт, к которому относятся загружаемые значения. Передается в виде объекта, со следующими атрибутами:

* `sku` [String] уникальный идентификатор продукта
* `name` [String] название/описание продукта (необязательно)

Если в базе еще нет продукта с указанным SKU, то он будет создан. В противном случае данные будут загружаться к созданному ранее продукту с таким SKU.

###### values

Массив значений. Каждый объект этого массива имеет следующие атрибуты:

* `value` [Float] значение
* `timestamp` [String] время, к которому относится это значение (например, '2014-01-01 00:00:00')

##### Ответ

В случае успеха возвращает массив созданных значений в том же формате, что и параметр `values` во входных данных.

В случае некорректных данных возвращает массив с описаниями ошибок.

##### Коды ответа

* `201` данные сохранены
* `422` переданы некорректные данные
* `403` нет доступа
* `500` ошибка сервера

##### Пример (ок)

###### Запрос

POST /api/v1/projects/my-shop/values
    
    {
      "item":{
        "sku":"shampoo",
        "name":"Шампунь для нормальных волос"
      },
      "values":[
        {
          "value":1,
          "timestamp":"2015-01-15 10:20:11"
        },
        {
          "value":2,
          "timestamp":"2015-01-16 09:00:17"
        }
      ]
    }

###### Ответ

    [
      {
        "value":{
          "value":1.0,
          "timestamp":"2015-01-15T10:20:11.000Z"
        }
      },
      {
        "value":{
          "value":2.0,
          "timestamp":"2015-01-16T09:00:17Z"
        }
      }
    ]


##### Пример (некорректные данные)

###### Запрос

POST /api/v1/projects/my-shop/values
    
    {
      "item":{
        "sku":"shampoo",
        "name":"Шампунь для нормальных волос"
      },
      "values":[
        {
          "value":1
        }
      ]
    }

###### Ответ

    [
      {
        "timestamp":[
          "can't be blank"
        ]
      }
    ]

### Шаг 1. Создание прогноза

#### POST /api/v1/projects/:project_id/forecasts

Сохраняет запрос на расчет прогноза по проекту с указанным в URL `project_id`.

##### Входные данные

###### forecast

Описание требуемого прогноза. Имеет следующие атрибуты:

* `period` [String] по каким периодам группировать значения для рассчетов. Возможные значения: "day", "month"
* `depth` [Integer] глубина прогноза. Измеряется в тех же величинах, что и параметр `period`
* `group_method` [String] способ группировки значений. Возможные значения: "sum", "average".

##### Ответ

В случае успеха возвращает описание созданого прогноза в виде:

* `id` [Integer] ID прогноза
* `period` [String] интервал прогноза
* `depth` [Integer] глубина прогноза
* `group_method` [String] способ группировки
* `workflow_state` [String] состояние прогноза ("planned" - запланирован, "started" - идет расчет, "finished" - прогноз готов)
* `planned_at` [String] время, на которое запланирован расчет прогноза (подбирается ближайшее ко времени отправки запроса)

В случае некорректных данных возвращает массив с описаниями ошибок.

##### Коды ответа

* `201` прогноз запланирован
* `422` переданы некорректные данные
* `403` нет доступа
* `500` ошибка сервера

##### Пример

Рассмотрим 2 примера.

1. После каждого заказа в магазине отправляются данные о только что проданных товарах (SKU товара и количество). Допустим, мы хотим узнать, как товары будут продаваться в последующих двух месяцах. При формировании такого прогноза нас интересует сумма продаж каждого товара за каждый месяц. Таким образом, надо отправить следующий запрос:

    `{ "forecast": { "period": "month", "depth": "2", "group_method": "sum" } }`

2. Каждый час мы загружаем данные о курсе доллара. Мы хотим рассчитать курс на следующие 5 дней. В этом случае нет смысла считать сумму значений, так как нас интересует среднее значение доллара каждый день. Поэтому запрос будет выглядеть следующим образом:

    `{ "forecast": { "period": "day", "depth": "5", "group_method": "average" } }`

### Шаг 3. Получение результатов прогноза.

#### GET /api/v1/projects/:project_id/forecasts

Возвращает массив всех имеющихся в проекте `project_id` прогнозов.

#### GET /api/v1/forecasts/:forecast_id/lines

Возвращает предсказанные значения прогноза с ID `forecast_id`.

##### Входные данные

Нет

##### Ответ

Возвращает массив спрогнозированных значений.

Каждому продукту проекта будет соответствовать свой объект "forecast_line". Также будет добавлен дополнительный "forecast_line" с атрибутом "summary": true, в котором будут расчитанны суммы прогнозов всех продуктов. Например:

    [
      {
        "forecast_line":{
          "item":{
            "sku":"ITEM_1"
          },
          "predicted_values":[
            {
              "from":"2015-02-17T00:00:00.000Z",
              "to":"2015-02-17T23:59:59.999Z",
              "timestamp":"2015-02-17",
              "value":1.0,
              "predicted":true
            },
            {
              "from":"2015-02-18T00:00:00.000Z",
              "to":"2015-02-18T23:59:59.999Z",
              "timestamp":"2015-02-18",
              "value":2.0,
              "predicted":true
            },
            {
              "from":"2015-02-19T00:00:00.000Z",
              "to":"2015-02-19T23:59:59.999Z",
              "timestamp":"2015-02-19",
              "value":3.0,
              "predicted":true
            },
            {
              "from":"2015-02-20T00:00:00.000Z",
              "to":"2015-02-20T23:59:59.999Z",
              "timestamp":"2015-02-20",
              "value":4.0,
              "predicted":true
            },
            {
              "from":"2015-02-21T00:00:00.000Z",
              "to":"2015-02-21T23:59:59.999Z",
              "timestamp":"2015-02-21",
              "value":5.0,
              "predicted":true
            }
          ]
        }
      },
      {
        "forecast_line":{
          "item":{
            "sku":"ITEM_2"
          },
          "predicted_values":[
            {
              "from":"2015-02-17T00:00:00.000Z",
              "to":"2015-02-17T23:59:59.999Z",
              "timestamp":"2015-02-17",
              "value":1.0,
              "predicted":true
            },
            {
              "from":"2015-02-18T00:00:00.000Z",
              "to":"2015-02-18T23:59:59.999Z",
              "timestamp":"2015-02-18",
              "value":2.0,
              "predicted":true
            },
            {
              "from":"2015-02-19T00:00:00.000Z",
              "to":"2015-02-19T23:59:59.999Z",
              "timestamp":"2015-02-19",
              "value":3.0,
              "predicted":true
            },
            {
              "from":"2015-02-20T00:00:00.000Z",
              "to":"2015-02-20T23:59:59.999Z",
              "timestamp":"2015-02-20",
              "value":4.0,
              "predicted":true
            },
            {
              "from":"2015-02-21T00:00:00.000Z",
              "to":"2015-02-21T23:59:59.999Z",
              "timestamp":"2015-02-21",
              "value":5.0,
              "predicted":true
            }
          ]
        }
      },
      {
        "forecast_line":{
          "predicted_values":[
            {
              "from":"2015-02-20T00:00:00.000Z",
              "to":"2015-02-20T23:59:59.999Z",
              "timestamp":"2015-02-20",
              "value":8.0,
              "predicted":true
            },
            {
              "from":"2015-02-17T00:00:00.000Z",
              "to":"2015-02-17T23:59:59.999Z",
              "timestamp":"2015-02-17",
              "value":2.0,
              "predicted":true
            },
            {
              "from":"2015-02-18T00:00:00.000Z",
              "to":"2015-02-18T23:59:59.999Z",
              "timestamp":"2015-02-18",
              "value":4.0,
              "predicted":true
            },
            {
              "from":"2015-02-21T00:00:00.000Z",
              "to":"2015-02-21T23:59:59.999Z",
              "timestamp":"2015-02-21",
              "value":10.0,
              "predicted":true
            },
            {
              "from":"2015-02-19T00:00:00.000Z",
              "to":"2015-02-19T23:59:59.999Z",
              "timestamp":"2015-02-19",
              "value":6.0,
              "predicted":true
            }
          ],
          "summary":true
        }
      }
    ]

##### Коды ответа

* `200` ок
* `403` нет доступа
* `500` ошибка сервера
